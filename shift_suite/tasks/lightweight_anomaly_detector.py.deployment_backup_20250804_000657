#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ãƒ–ãƒ«ãƒ¼ãƒ—ãƒªãƒ³ãƒˆåˆ†æ Phase 3: è»½é‡ç•°å¸¸æ¤œçŸ¥æ©Ÿèƒ½
ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–ã®å®Ÿç”¨çš„ãªç•°å¸¸æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
"""

from typing import Dict, List, Any, Optional, Tuple
import pandas as pd
import numpy as np
import logging
from datetime import datetime, timedelta
from collections import defaultdict
from dataclasses import dataclass

# shift_suite ã®å®šæ•°ã‚’ä½¿ç”¨
try:
    from .constants import SLOT_HOURS
except ImportError:
    SLOT_HOURS = 0.5

log = logging.getLogger(__name__)

@dataclass
class AnomalyResult:
    """ç•°å¸¸æ¤œçŸ¥çµæœã‚’æ ¼ç´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹"""
    anomaly_type: str
    severity: str  # "ä½", "ä¸­", "é«˜", "ç·Šæ€¥"
    staff: str
    description: str
    value: float
    expected_range: Tuple[float, float]
    date_range: Optional[Tuple[str, str]] = None
    
class LightweightAnomalyDetector:
    """
    è»½é‡ç•°å¸¸æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
    Phase 3: å®Ÿç”¨æ€§ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’é‡è¦–ã—ãŸè¨­è¨ˆ
    """
    
    def __init__(self, sensitivity: str = "medium"):
        """
        åˆæœŸåŒ–
        
        Args:
            sensitivity: æ¤œçŸ¥æ„Ÿåº¦ ("low", "medium", "high")
        """
        self.sensitivity = sensitivity
        self.thresholds = self._get_thresholds(sensitivity)
        log.info(f"[AnomalyDetector] è»½é‡ç•°å¸¸æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº† (æ„Ÿåº¦: {sensitivity})")
    
    def _get_thresholds(self, sensitivity: str) -> Dict[str, float]:
        """æ„Ÿåº¦ã«åŸºã¥ãé–¾å€¤è¨­å®š"""
        base_thresholds = {
            "excessive_hours_multiplier": 1.5,  # é€šå¸¸ã®1.5å€ä»¥ä¸Šã®åŠ´åƒæ™‚é–“
            "continuous_work_days": 7,          # é€£ç¶šå‹¤å‹™æ—¥æ•°ã®ä¸Šé™
            "night_shift_frequency": 0.4,       # å¤œå‹¤é »åº¦ã®ä¸Šé™ï¼ˆ40%ï¼‰
            "interval_violation_hours": 11,     # å‹¤å‹™é–“ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«é•åï¼ˆ11æ™‚é–“æœªæº€ï¼‰
            "outlier_std_multiplier": 2.0       # å¤–ã‚Œå€¤æ¤œçŸ¥ï¼ˆå¹³å‡Â±2Ïƒï¼‰
        }
        
        # æ„Ÿåº¦ã«ã‚ˆã‚‹èª¿æ•´
        if sensitivity == "high":
            for key in base_thresholds:
                if "multiplier" in key:
                    base_thresholds[key] *= 0.8  # ã‚ˆã‚Šå³ã—ã
                elif key == "continuous_work_days":
                    base_thresholds[key] = 5    # ã‚ˆã‚Šå³ã—ã
        elif sensitivity == "low":
            for key in base_thresholds:
                if "multiplier" in key:
                    base_thresholds[key] *= 1.2  # ã‚ˆã‚Šç·©ã
                elif key == "continuous_work_days":
                    base_thresholds[key] = 10   # ã‚ˆã‚Šç·©ã
        
        return base_thresholds
    
    def detect_anomalies(self, long_df: pd.DataFrame) -> List[AnomalyResult]:
        """
        è»½é‡ç•°å¸¸æ¤œçŸ¥ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†
        
        Args:
            long_df: é•·å½¢å¼ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿
            
        Returns:
            æ¤œçŸ¥ã•ã‚ŒãŸç•°å¸¸ã®ãƒªã‚¹ãƒˆ
        """
        log.info("[AnomalyDetector] ç•°å¸¸æ¤œçŸ¥é–‹å§‹")
        
        if long_df.empty:
            log.warning("[AnomalyDetector] å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™")
            return []
        
        # ãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†
        work_records = long_df[long_df['parsed_slots_count'] > 0].copy()
        if work_records.empty:
            log.warning("[AnomalyDetector] æœ‰åŠ¹ãªå‹¤å‹™ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“")
            return []
        
        anomalies = []
        
        try:
            # 1. åŠ´åƒæ™‚é–“ç•°å¸¸ã®æ¤œçŸ¥ï¼ˆæœ€å„ªå…ˆãƒ»è»½é‡ï¼‰
            log.info("[AnomalyDetector] åŠ´åƒæ™‚é–“ç•°å¸¸æ¤œçŸ¥é–‹å§‹")
            anomalies.extend(self._detect_excessive_hours(work_records))
            
            # 2. é€£ç¶šå‹¤å‹™ç•°å¸¸ã®æ¤œçŸ¥ï¼ˆæ³•ä»¤éµå®ˆï¼‰
            log.info("[AnomalyDetector] é€£ç¶šå‹¤å‹™ç•°å¸¸æ¤œçŸ¥é–‹å§‹")
            anomalies.extend(self._detect_continuous_work_violations(work_records))
            
            # 3. å¤œå‹¤é »åº¦ç•°å¸¸ã®æ¤œçŸ¥ï¼ˆå¥åº·ç®¡ç†ï¼‰
            log.info("[AnomalyDetector] å¤œå‹¤é »åº¦ç•°å¸¸æ¤œçŸ¥é–‹å§‹")
            anomalies.extend(self._detect_night_shift_anomalies(work_records))
            
            # 4. å‹¤å‹™é–“ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«é•åï¼ˆè»½é‡ç‰ˆï¼‰
            log.info("[AnomalyDetector] å‹¤å‹™é–“ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«é•åæ¤œçŸ¥é–‹å§‹")
            anomalies.extend(self._detect_interval_violations(work_records))
            
        except Exception as e:
            log.error(f"[AnomalyDetector] ç•°å¸¸æ¤œçŸ¥ä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")
            raise
        
        log.info(f"[AnomalyDetector] ç•°å¸¸æ¤œçŸ¥å®Œäº†: {len(anomalies)}ä»¶ã®ç•°å¸¸ã‚’æ¤œçŸ¥")
        return sorted(anomalies, key=lambda x: self._get_severity_priority(x.severity))
    
    def _detect_excessive_hours(self, work_df: pd.DataFrame) -> List[AnomalyResult]:
        """éåº¦ãªåŠ´åƒæ™‚é–“ã®æ¤œçŸ¥ï¼ˆO(n)ï¼‰"""
        anomalies = []
        
        # å€‹äººåˆ¥ã®æœˆé–“åŠ´åƒæ™‚é–“ã‚’è¨ˆç®—
        work_df['year_month'] = work_df['ds'].dt.to_period('M')
        monthly_hours = work_df.groupby(['staff', 'year_month'])['parsed_slots_count'].sum() * SLOT_HOURS
        
        # å…¨ä½“å¹³å‡ã‚’åŸºæº–ã¨ã—ãŸç•°å¸¸æ¤œçŸ¥
        overall_mean = monthly_hours.mean()
        threshold = overall_mean * self.thresholds["excessive_hours_multiplier"]
        
        for (staff, month), hours in monthly_hours.items():
            if hours > threshold:
                severity = self._calculate_severity(hours, threshold, overall_mean * 2)
                anomalies.append(AnomalyResult(
                    anomaly_type="éåº¦ãªåŠ´åƒæ™‚é–“",
                    severity=severity,
                    staff=staff,
                    description=f"{month}ã®åŠ´åƒæ™‚é–“ãŒç•°å¸¸ã«å¤šã„ ({hours:.1f}æ™‚é–“)",
                    value=hours,
                    expected_range=(0, threshold),
                    date_range=(str(month.start_time.date()), str(month.end_time.date()))
                ))
        
        return anomalies
    
    def _detect_continuous_work_violations(self, work_df: pd.DataFrame) -> List[AnomalyResult]:
        """é€£ç¶šå‹¤å‹™æ—¥æ•°é•åã®æ¤œçŸ¥ï¼ˆO(n log n)ï¼‰"""
        anomalies = []
        
        for staff, group in work_df.groupby('staff'):
            # æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆã—ã¦é€£ç¶šå‹¤å‹™ã‚’æ¤œå‡º
            work_dates = group['ds'].dt.date.unique()
            work_dates.sort()
            
            if len(work_dates) < 2:
                continue
            
            continuous_days = 1
            start_date = work_dates[0]
            
            for i in range(1, len(work_dates)):
                if (work_dates[i] - work_dates[i-1]).days == 1:
                    continuous_days += 1
                else:
                    # é€£ç¶šå‹¤å‹™æœŸé–“ã®çµ‚äº†ã‚’ãƒã‚§ãƒƒã‚¯
                    if continuous_days > self.thresholds["continuous_work_days"]:
                        severity = self._calculate_severity(
                            continuous_days, 
                            self.thresholds["continuous_work_days"], 
                            self.thresholds["continuous_work_days"] + 5
                        )
                        anomalies.append(AnomalyResult(
                            anomaly_type="é€£ç¶šå‹¤å‹™é•å",
                            severity=severity,
                            staff=staff,
                            description=f"{continuous_days}æ—¥é–“ã®é€£ç¶šå‹¤å‹™ã‚’æ¤œå‡º",
                            value=continuous_days,
                            expected_range=(0, self.thresholds["continuous_work_days"]),
                            date_range=(str(start_date), str(work_dates[i-1]))
                        ))
                    
                    continuous_days = 1
                    start_date = work_dates[i]
            
            # æœ€å¾Œã®é€£ç¶šå‹¤å‹™æœŸé–“ã‚‚ãƒã‚§ãƒƒã‚¯
            if continuous_days > self.thresholds["continuous_work_days"]:
                severity = self._calculate_severity(
                    continuous_days, 
                    self.thresholds["continuous_work_days"], 
                    self.thresholds["continuous_work_days"] + 5
                )
                anomalies.append(AnomalyResult(
                    anomaly_type="é€£ç¶šå‹¤å‹™é•å",
                    severity=severity,
                    staff=staff,
                    description=f"{continuous_days}æ—¥é–“ã®é€£ç¶šå‹¤å‹™ã‚’æ¤œå‡º",
                    value=continuous_days,
                    expected_range=(0, self.thresholds["continuous_work_days"]),
                    date_range=(str(start_date), str(work_dates[-1]))
                ))
        
        return anomalies
    
    def _detect_night_shift_anomalies(self, work_df: pd.DataFrame) -> List[AnomalyResult]:
        """å¤œå‹¤é »åº¦ç•°å¸¸ã®æ¤œçŸ¥ï¼ˆO(n)ï¼‰"""
        anomalies = []
        
        for staff, group in work_df.groupby('staff'):
            total_shifts = len(group)
            night_shifts = group[group['code'].str.contains('å¤œ', na=False)].shape[0]
            night_shift_ratio = night_shifts / total_shifts if total_shifts > 0 else 0
            
            if night_shift_ratio > self.thresholds["night_shift_frequency"]:
                severity = self._calculate_severity(
                    night_shift_ratio, 
                    self.thresholds["night_shift_frequency"], 
                    0.6
                )
                anomalies.append(AnomalyResult(
                    anomaly_type="å¤œå‹¤é »åº¦éå¤š",
                    severity=severity,
                    staff=staff,
                    description=f"å¤œå‹¤é »åº¦ãŒé«˜ã™ãã¾ã™ ({night_shift_ratio:.1%})",
                    value=night_shift_ratio,
                    expected_range=(0, self.thresholds["night_shift_frequency"])
                ))
        
        return anomalies
    
    def _detect_interval_violations(self, work_df: pd.DataFrame) -> List[AnomalyResult]:
        """å‹¤å‹™é–“ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«é•åã®æ¤œçŸ¥ï¼ˆè»½é‡ç‰ˆï¼‰ï¼ˆO(n log n)ï¼‰"""
        anomalies = []
        
        for staff, group in work_df.groupby('staff'):
            # æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆã—ã¦å‹¤å‹™é–“ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’è¨ˆç®—
            sorted_group = group.sort_values('ds')
            
            violations = 0
            total_intervals = 0
            
            for i in range(1, len(sorted_group)):
                prev_end = sorted_group.iloc[i-1]['ds']
                curr_start = sorted_group.iloc[i]['ds']
                
                # ç°¡æ˜“çš„ãªé–“éš”è¨ˆç®—ï¼ˆå®Ÿéš›ã®çµ‚äº†æ™‚é–“ã¯æ¨å®šï¼‰
                interval_hours = (curr_start - prev_end).total_seconds() / 3600
                
                if 0 < interval_hours < self.thresholds["interval_violation_hours"]:
                    violations += 1
                
                total_intervals += 1
            
            if violations > 0 and total_intervals > 0:
                violation_rate = violations / total_intervals
                
                if violation_rate > 0.1:  # 10%ä»¥ä¸Šã®é•åç‡
                    severity = self._calculate_severity(violation_rate, 0.1, 0.3)
                    anomalies.append(AnomalyResult(
                        anomaly_type="å‹¤å‹™é–“ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«é•å",
                        severity=severity,
                        staff=staff,
                        description=f"å‹¤å‹™é–“ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«é•åãŒå¤šç™º ({violations}/{total_intervals})",
                        value=violation_rate,
                        expected_range=(0, 0.1)
                    ))
        
        return anomalies
    
    def _calculate_severity(self, value: float, warning_threshold: float, critical_threshold: float) -> str:
        """é‡è¦åº¦ã®è¨ˆç®—"""
        if value >= critical_threshold:
            return "ç·Šæ€¥"
        elif value >= warning_threshold * 1.5:
            return "é«˜"
        elif value >= warning_threshold * 1.2:
            return "ä¸­"
        else:
            return "ä½"
    
    def _get_severity_priority(self, severity: str) -> int:
        """é‡è¦åº¦ã®å„ªå…ˆé †ä½ï¼ˆã‚½ãƒ¼ãƒˆç”¨ï¼‰"""
        priority_map = {"ç·Šæ€¥": 0, "é«˜": 1, "ä¸­": 2, "ä½": 3}
        return priority_map.get(severity, 4)
    
    def generate_anomaly_summary(self, anomalies: List[AnomalyResult]) -> Dict[str, Any]:
        """ç•°å¸¸æ¤œçŸ¥çµæœã®ã‚µãƒãƒªãƒ¼ç”Ÿæˆ"""
        if not anomalies:
            return {"message": "ç•°å¸¸ã¯æ¤œçŸ¥ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ", "total_anomalies": 0}
        
        summary = {
            "detection_timestamp": datetime.now().isoformat(),
            "total_anomalies": len(anomalies),
            "by_severity": defaultdict(int),
            "by_type": defaultdict(int),
            "by_staff": defaultdict(int),
            "top_issues": []
        }
        
        for anomaly in anomalies:
            summary["by_severity"][anomaly.severity] += 1
            summary["by_type"][anomaly.anomaly_type] += 1
            summary["by_staff"][anomaly.staff] += 1
        
        # ä¸Šä½å•é¡Œã®æŠ½å‡ºï¼ˆç·Šæ€¥ãƒ»é«˜é‡è¦åº¦ã®ã¿ï¼‰
        critical_anomalies = [a for a in anomalies if a.severity in ["ç·Šæ€¥", "é«˜"]]
        summary["top_issues"] = [
            {
                "type": a.anomaly_type,
                "staff": a.staff,
                "description": a.description,
                "severity": a.severity
            }
            for a in critical_anomalies[:5]  # ä¸Šä½5ä»¶
        ]
        
        return dict(summary)

def test_lightweight_anomaly_detector():
    """è»½é‡ç•°å¸¸æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆ"""
    print("ğŸ§ª è»½é‡ç•°å¸¸æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆé–‹å§‹")
    
    # ãƒ†ã‚¹ãƒˆç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä½œæˆ
    sample_data = {
        'ds': pd.date_range('2025-01-01 08:00', periods=50, freq='8H'),
        'staff': (['ç”°ä¸­'] * 25 + ['ä½è—¤'] * 25),
        'role': ['ä»‹è­·å£«'] * 50,
        'code': (['æ—¥å‹¤'] * 20 + ['å¤œå‹¤'] * 15 + ['æ—¥å‹¤'] * 10 + ['å¤œå‹¤'] * 5),
        'holiday_type': [''] * 50,
        'parsed_slots_count': [1] * 50
    }
    
    sample_df = pd.DataFrame(sample_data)
    
    # ç•°å¸¸æ¤œçŸ¥ãƒ†ã‚¹ãƒˆ
    detector = LightweightAnomalyDetector(sensitivity="medium")
    anomalies = detector.detect_anomalies(sample_df)
    
    print(f"æ¤œçŸ¥ã•ã‚ŒãŸç•°å¸¸æ•°: {len(anomalies)}")
    for anomaly in anomalies:
        print(f"  - {anomaly.severity}: {anomaly.anomaly_type} ({anomaly.staff})")
        print(f"    {anomaly.description}")
    
    # ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
    summary = detector.generate_anomaly_summary(anomalies)
    print(f"\nã‚µãƒãƒªãƒ¼: {summary['total_anomalies']}ä»¶ã®ç•°å¸¸")
    
    print("âœ… è»½é‡ç•°å¸¸æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆå®Œäº†")
    return anomalies, summary

if __name__ == "__main__":
    test_lightweight_anomaly_detector()